<!DOCTYPE html><html><head><title>预测型数据分析实践：用scikit-learn实现数据挖掘建模全过程</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style>.note-content  {font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif;width:800px;margin:0 auto;}</style></head><body><div id='preview-contents' class='note-content'>
                        
                    

<h2 id="预测型数据分析实践：用scikit-learn实现数据挖掘建模全过程">预测型数据分析实践：用scikit-learn实现数据挖掘建模全过程</h2>
<p><a href="http://class.pkbigdata.com/#/classDetail/classIntroduce/1" target="_blank" style="color:darkblue;background-color:lightblue">数据分析师（入门）</a>&nbsp &nbsp &nbsp<a href="https://class.pkbigdata.com" target="_blank" style="color:darkblue;background-color:lightblue">DC学院</a></p>
<p>本节课程会使用一个房屋售价的数据集讲解从探索型数据分析到数据建模的过程和方法。</p>



<h3 id="探索型数据分析">探索型数据分析</h3>

<p><strong>1. 导入数据</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
</div><div class="hljs-line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
</div><div class="hljs-line">%matplotlib notebook
</div><div class="hljs-line">housing_df = pd.read_csv(<span class="hljs-string">'housing.csv'</span>)<span class="hljs-comment">#具体路径为housing.csv文件保存的绝对路径</span>
</div><div class="hljs-line">housing_df.head(<span class="hljs-number">5</span>)
</div></code></pre>

<p><strong>注意：</strong></p>

<ul><li>这里使用%matpoltlib notebook将绘制的图片内嵌在交互窗口，并且可以方便进一步操作和保存（新绘制另一张图形的时候需要首先点击关闭上一张图形）；</li>
<li>数据集的下载地址为：<a href="http://pan.baidu.com/s/1hrDiVQW" target="_blank">链接</a>  ，密码:dck0</li>
</ul>

<p><strong>2. 查看数据的属性</strong> </p>

<ul><li>使用print(housing_df.columns)查看数据集中的属性名称</li>
<li>打开housing_description.txt文件直接查看各个属性的详细说明</li>
</ul>

<p><strong>3. 绘制房屋价格分布图</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line">sns.distplot(housing_df[<span class="hljs-string">'SalePrice'</span>])
</div></code></pre>

<ul><li>房屋价格对应的属性是’SalePrice’</li>
<li>可以从图中看到，SalePrice的分布图大致服从右偏态分布，平均数大于中位数</li>
<li>大部分房屋价格在100000到300000之间</li>
<li>有少量的房屋价格大于500000</li>
</ul>

<p><strong>4. 绘制居住面积分布图</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line">sns.distplot(housing_df[<span class="hljs-string">'GrLivArea'</span>])
</div></code></pre>

<ul><li>居住面积对应的属性是’GrLivArea’</li>
<li>大部分房屋的居住面积在800到2000之间</li>
<li>有少量的房屋居住面积大于4000</li>
</ul>

<p><strong>5. 地下室面积分布图</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line">sns.distplot(housing_df[<span class="hljs-string">'TotalBsmtSF'</span>])
</div></code></pre>

<ul><li>地下室面积对应的属性是’TotalBsmtSF’</li>
<li>有一部分的房屋地下室面积为0，也就是没有地下室</li>
</ul>

<p><strong>6. 探索连续型变量之间的相关性</strong> <br>
可以使用seaborn的regplot方法，探索探索两个连续型变量之间的相关性。</p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-comment">#连续变量之间的相关性</span>
</div><div class="hljs-line">sns.regplot(x=<span class="hljs-string">'GrLivArea'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div><div class="hljs-line">sns.regplot(x=<span class="hljs-string">'TotalBsmtSF'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div></code></pre>

<ul><li>从代码生成的图中可以看到，GrLivArea和SalePrice呈现明显的正相关关系</li>
<li>从代码生成的图中可以看到，TotalBsmtSF和SalePrice呈现明显的正相关关系</li>
</ul>

<p><strong>7. 探索离散型变量和连续型变量之间的相关性</strong> <br>
可以使用seaborn的boxplot方法，探索离散型变量和连续型变量之间的相关性。</p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-comment">#离散变量和连续变量之间的相关性</span>
</div><div class="hljs-line"><span class="hljs-comment">#使用regplot绘制OverallQual和SalePrice之间的关系，比较跟boxplot的区别</span>
</div><div class="hljs-line">sns.regplot(x=<span class="hljs-string">'OverallQual'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div><div class="hljs-line"><span class="hljs-comment">#使用boxplot绘制OverallQual和SalePrice之间的关系</span>
</div><div class="hljs-line">sns.boxplot(x=<span class="hljs-string">'OverallQual'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div><div class="hljs-line"><span class="hljs-comment">#使用boxplot绘制CentralAir和SalePrice之间的关系</span>
</div><div class="hljs-line">sns.boxplot(x=<span class="hljs-string">'CentralAir'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div><div class="hljs-line"><span class="hljs-comment">#使用boxplot绘制Neighborhood和SalePrice之间的关系</span>
</div><div class="hljs-line">sns.boxplot(x=<span class="hljs-string">'Neighborhood'</span>, y=<span class="hljs-string">'SalePrice'</span>, data=housing_df)
</div></code></pre>

<p><strong>8. 绘制相关系数矩阵热力图</strong> <br>
从housing_df数据框中挑选出SalePrice，GrLivArea，TotalBsmtSF，GarageArea，YearBuilt，OverallQual等属性，计算这些属性之间的相关系数矩阵，并使用seaborn的heatmap方法绘制相关系数矩阵热力图，可以快速并且直观地探索出与SalePrice相关的属性。</p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-comment">#挑选属性</span>
</div><div class="hljs-line">info = [<span class="hljs-string">'SalePrice'</span>,<span class="hljs-string">'GrLivArea'</span>,<span class="hljs-string">'TotalBsmtSF'</span>,<span class="hljs-string">'GarageArea'</span>,<span class="hljs-string">'YearBuilt'</span>,<span class="hljs-string">'OverallQual'</span>]
</div><div class="hljs-line"><span class="hljs-comment">#把图形中的字体设置为原来的0.7倍</span>
</div><div class="hljs-line">sns.set(font_scale = <span class="hljs-number">0.7</span>)
</div><div class="hljs-line"><span class="hljs-comment">#首先使用.corr()方法计算属性之间的相关系数矩阵，再使用heatmap绘制热力图</span>
</div><div class="hljs-line"><span class="hljs-comment">#annot=True的作用是把相关系数在图中注释出来</span>
</div><div class="hljs-line">sns.heatmap(housing_df[info].corr(), annot = <span class="hljs-keyword">True</span>, vmin = <span class="hljs-number">0</span>, vmax = <span class="hljs-number">1</span>)
</div></code></pre>

<ul><li>从代码生成的热力图可以看出，SalePrice跟OverallQual的相关性最高，相关系数为0.79，SalePrice跟YearBuilt的相关性最低，相关系数为0.52</li>
</ul>



<h3 id="预测型数据分析">预测型数据分析</h3>

<p><strong>1. 预测型数据分析的注意事项</strong></p>

<ul><li>首先使用探索型数据分析方法，探索出跟预测目标相关的特征</li>
<li>对相关的特征进行数据处理使其更加符合数据建模的要求</li>
<li>特征挑选应该同时注重模型的准确率和可解释性</li>
</ul>

<p><strong>2. 使用线性回归和逻辑森林回归建立预测模型</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
</div><div class="hljs-line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
</div><div class="hljs-line"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
</div><div class="hljs-line"><span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor
</div><div class="hljs-line"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score
</div><div class="hljs-line">
</div><div class="hljs-line">housing_df = data = pd.read_csv(<span class="hljs-string">'housing.csv'</span>)
</div><div class="hljs-line">features = [<span class="hljs-string">'GrLivArea'</span>,<span class="hljs-string">'TotalBsmtSF'</span>,<span class="hljs-string">'GarageArea'</span>,<span class="hljs-string">'YearBuilt'</span>,<span class="hljs-string">'OverallQual'</span>]
</div><div class="hljs-line">target = <span class="hljs-string">'SalePrice'</span>
</div><div class="hljs-line">lr = LinearRegression()
</div><div class="hljs-line">rf = RandomForestRegressor(<span class="hljs-number">100</span>)<span class="hljs-comment">#可以改变括号里的值（也就是子树的个数）来得到更优的回归效果</span>
</div><div class="hljs-line">
</div><div class="hljs-line">models = [lr, rf]
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> models:
</div><div class="hljs-line">    scores = cross_val_score(model, housing_df[features], housing_df[target], cv = <span class="hljs-number">5</span>, scoring = <span class="hljs-string">'neg_mean_absolute_error'</span>)
</div><div class="hljs-line">    print(type(model).__name__, np.mean(scores))
</div></code></pre>

<p><strong>3. 创建新的特征</strong> <br>
可以根据数据集原来的特征，创建新的对于预测目标有帮助的新特征，用于得到更好的效果。</p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line">housing_df[<span class="hljs-string">'HasBsmt'</span>] = <span class="hljs-number">0</span>
</div><div class="hljs-line">housing_df.at[housing_df[<span class="hljs-string">'TotalBsmtSF'</span>] &gt; <span class="hljs-number">0</span>, <span class="hljs-string">'HasBsmt'</span>] = <span class="hljs-number">1</span>
</div><div class="hljs-line">housing_df[<span class="hljs-string">'LogArea'</span>] = np.log(housing_df[<span class="hljs-string">'GrLivArea'</span>])
</div><div class="hljs-line">
</div><div class="hljs-line">new_features = [<span class="hljs-string">'GrLivArea'</span>,<span class="hljs-string">'TotalBsmtSF'</span>,<span class="hljs-string">'GarageArea'</span>,<span class="hljs-string">'YearBuilt'</span>,<span class="hljs-string">'OverallQual'</span>,<span class="hljs-string">'HasBsmt'</span>]
</div><div class="hljs-line">
</div><div class="hljs-line">lr = LinearRegression()
</div><div class="hljs-line">rf = RandomForestRegressor(<span class="hljs-number">100</span>)
</div><div class="hljs-line">
</div><div class="hljs-line">models = [lr, rf]
</div><div class="hljs-line">
</div><div class="hljs-line"><span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> models:
</div><div class="hljs-line">    scores = cross_val_score(model, housing_df[new_features], housing_df[target],cv = <span class="hljs-number">5</span>, scoring = <span class="hljs-string">'neg_mean_absolute_error'</span>)
</div><div class="hljs-line">    print(type(model).__name__, np.mean(scores))
</div></code></pre>

<ul><li>根据特征’TotalBsmtSF’创建一个新特征’HasBsmt’，也就是房屋是否有地下室。当’TotalBsmtSF’为0时’HasBsmt’为0，当’TotalBsmtSF’大于0时’HasBsmt’为1</li>
<li>根据特征’GrLivArea’创建一个新特征’LogArea’，也就是取特征’GrLivArea’的对数，缩小特征’GrLivArea’之间的差异</li>
<li>可以看到新特征对预测的效果有一定的帮助，其效果跟不同模型的内在机制存在一定的关系</li>
</ul>



<h2 id="补充知识">补充知识</h2>



<h3 id="参数文档">参数文档</h3>



<h4 id="seabornheatmap">seaborn.heatmap()</h4>

<ul><li><a href="http://seaborn.pydata.org/generated/seaborn.heatmap.html" target="_blank">seaborn.heatmap()</a>，阅读seaborn的官方文档，掌握热力图heatmap的更多用法。</li>
</ul></div></body></html>



<p align="center">
	<a href="http://class.pkbigdata.com/#/classDetail/classIntroduce/1" target="_blank" style="color:darkblue">数据分析师（入门）&nbsp &nbsp  港科大博后 王乐业 &nbsp 主讲</a><br><br>
	<a href="http://class.pkbigdata.com" target="_blank" style="color:darkblue">更多数据科学课程，上DC学院</a><br><br><br>
	<img longdesc="./屏幕快照 2017-06-20 下午9.50.07.png" alt="Alt text" title="" type="image/png" class="" width="200" src="http://a2.qpic.cn/psb?/V11Gjour0xUbvS/tTU8X69B5.PR.qIkcsMZwAGzGM1v9V9cfxsRWxjj7SE!/b/dGwBAAAAAAAA&bo=rgGuAQAAAAARBzA!&rf=viewer_4"><br>
	关注DC，获取更多学习资源
</p>